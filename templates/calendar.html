{% extends "base.html" %}

{% block content %}
<h2>My Order Calendar</h2>

<div style="margin-bottom: 1rem;">
  <a href="{{ url_for('profile.view_profile') }}" class="button ghost">‚Üê Back to Profile</a>
</div>

<!-- Calendar Container -->
<div style="background: white; padding: 2rem; border: 1px solid #e1e4e8; border-radius: 6px; margin-top: 2rem;">
  <div id="calendar"></div>
</div>

<!-- Order Statistics -->
<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 2rem;">
  <div style="background: white; padding: 1.5rem; border: 1px solid #e1e4e8; border-radius: 6px; text-align: center;">
    <div style="font-size: 2rem; font-weight: bold; color: #2c3e50;">{{ orders|length }}</div>
    <div style="color: #6a737d; font-size: 0.9rem;">Total Orders</div>
  </div>
  
  <div style="background: white; padding: 1.5rem; border: 1px solid #e1e4e8; border-radius: 6px; text-align: center;">
    <div style="font-size: 2rem; font-weight: bold; color: #2c3e50;">${{ orders|sum(attribute='total')|round(2) }}</div>
    <div style="color: #6a737d; font-size: 0.9rem;">Total Spent</div>
  </div>
  
  <div style="background: white; padding: 1.5rem; border: 1px solid #e1e4e8; border-radius: 6px; text-align: center;">
    {% set this_month_orders = orders|selectattr('created_at.month', 'equalto', current_month)|selectattr('created_at.year', 'equalto', current_year)|list %}
    <div style="font-size: 2rem; font-weight: bold; color: #2c3e50;">{{ this_month_orders|length }}</div>
    <div style="color: #6a737d; font-size: 0.9rem;">This Month</div>
  </div>
  
  <div style="background: white; padding: 1.5rem; border: 1px solid #e1e4e8; border-radius: 6px; text-align: center;">
    {% set avg = (orders|sum(attribute='total') / orders|length) if orders|length > 0 else 0 %}
    <div style="font-size: 2rem; font-weight: bold; color: #2c3e50;">${{ avg|round(2) }}</div>
    <div style="color: #6a737d; font-size: 0.9rem;">Avg Order Value</div>
  </div>
</div>

<!-- Recent Orders List -->
<div style="background: white; padding: 2rem; border: 1px solid #e1e4e8; border-radius: 6px; margin-top: 2rem;">
  <h3>Recent Orders</h3>
  
  {% if orders %}
    <table style="width: 100%; margin-top: 1rem;">
      <thead>
        <tr>
          <th>Order #</th>
          <th>Date</th>
          <th>Items</th>
          <th>Total</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for order in orders|sort(attribute='created_at', reverse=True)|slice(10) %}
        <tr>
          <td>#{{ order.id }}</td>
          <td>{{ order.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
          <td>{{ order.items|length }}</td>
          <td>${{ '%.2f'|format(order.total) }}</td>
          <td>
            <span style="padding: 0.25rem 0.75rem; background: #28a745; color: white; border-radius: 12px; font-size: 0.85rem;">
              Completed
            </span>
          </td>
          <td>
            <a href="{{ url_for('calendar.order_details', order_id=order.id) }}" style="color: #2c3e50; text-decoration: none;">View Details</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p style="text-align: center; color: #6a737d; padding: 2rem;">No orders yet</p>
  {% endif %}
</div>

<!-- Include FullCalendar CSS and JS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<style>
  /* Calendar Styling */
  #calendar {
    max-width: 100%;
    margin: 0 auto;
  }
  
  .fc {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  }
  
  .fc-toolbar-title {
    font-size: 1.5rem !important;
    font-weight: 600 !important;
    color: #2c3e50 !important;
  }
  
  .fc-button {
    background: #2c3e50 !important;
    border-color: #2c3e50 !important;
  }
  
  .fc-button:hover {
    background: #34495e !important;
    border-color: #34495e !important;
  }
  
  .fc-button:disabled {
    opacity: 0.5;
  }
  
  .fc-event {
    cursor: pointer;
  }
  
  .fc-daygrid-day-number {
    color: #2c3e50;
    font-weight: 500;
  }
  
  .fc-day-today {
    background-color: #fff3cd !important;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var calendarEl = document.getElementById('calendar');
  
  var calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    initialDate: '{{ current_year }}-{{ '%02d'|format(current_month) }}-01',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,listWeek'
    },
    events: '{{ url_for("calendar.get_orders_json") }}',
    eventClick: function(info) {
      info.jsEvent.preventDefault();
      if (info.event.url) {
        window.location.href = info.event.url;
      }
    },
    eventDidMount: function(info) {
      // Add tooltip
      info.el.title = info.event.extendedProps.items + ' items - ' + info.event.extendedProps.address;
    },
    height: 'auto',
    contentHeight: 600,
    aspectRatio: 1.8
  });
  
  calendar.render();
});
</script>

{% endblock %}