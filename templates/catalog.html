{% extends "base.html" %}

{% block content %}
<div style="margin-bottom: 1rem;">
  <a href="{{ url_for('catalog.categories') }}" class="button ghost">← Back to Categories</a>
</div>

<h2>{{ category_display }}</h2>

<form method="get" class="form-card" style="margin-bottom: 1rem;">
  {% if category %}
  <input type="hidden" name="category" value="{{ category }}">
  {% endif %}

  <label for="q">Search by name or color</label>
  <input type="text" id="q" name="q" value="{{ query }}">

  <label for="color">Filter by color</label>
  <input type="text" id="color" name="color" value="{{ color_filter }}">

  <label for="min_price">Min Price</label>
  <input type="number" id="min_price" name="min_price" step="0.01" value="{{ min_price }}">

  <label for="max_price">Max Price</label>
  <input type="number" id="max_price" name="max_price" step="0.01" value="{{ max_price }}">

  <label for="size">Size</label>
  <input type="number" id="size" name="size" value="{{ size }}">

  <label>
    <input type="checkbox" name="in_stock" {% if in_stock %}checked{% endif %}>
    In stock only
  </label>

  <label for="sort_by">Sort by</label>
  <select id="sort_by" name="sort_by">
    <option value="">-- Default --</option>
    <option value="name_asc" {% if sort_by == 'name_asc' %}selected{% endif %}>Name (A-Z)</option>
    <option value="name_desc" {% if sort_by == 'name_desc' %}selected{% endif %}>Name (Z-A)</option>
    <option value="price_asc" {% if sort_by == 'price_asc' %}selected{% endif %}>Price (Low to High)</option>
    <option value="price_desc" {% if sort_by == 'price_desc' %}selected{% endif %}>Price (High to Low)</option>
  </select>

  <button type="submit">Apply Filters</button>
</form>

<div class="product-grid">
  {% for p in products %}
    <div class="product-card">
      <!-- Clickable product name -->
      <h3><a href="{{ url_for('catalog.product_detail', product_id=p.id) }}" style="text-decoration: none; color: #2c3e50;">{{ p.name }}</a></h3>

      <!-- Rating Display -->
      <div style="margin: 0.5rem 0; color: #f39c12;">
        {% set rating = p.get_average_rating() %}
        {% if rating > 0 %}
          {% for i in range(1, 6) %}
            {% if i <= rating %}
              ⭐
            {% else %}
              ☆
            {% endif %}
          {% endfor %}
          <span style="color: #6a737d; font-size: 0.9rem;">({{ p.get_rating_count() }})</span>
        {% else %}
          <span style="color: #6a737d; font-size: 0.9rem;">No reviews yet</span>
        {% endif %}
      </div>

      <p>{{ p.description }}</p>
      <p><strong>Color:</strong> {{ p.color }}</p>
      <p><strong>Sizes:</strong> {{ p.sizes|join(', ') }}</p>
      <p><strong>Price:</strong> ${{ '%.2f'|format(p.price) }}</p>
      <p><strong>In stock:</strong> {{ p.stock }}</p>

      <!-- View Details Button -->
      <a href="{{ url_for('catalog.product_detail', product_id=p.id) }}" class="button ghost" style="display: block; text-align: center; margin-bottom: 0.5rem;">View Details</a>

      {% if session.get('user_email') %}
          {% if p.stock > 0 %}
            <form action="{{ url_for('cart.add', product_id=p.id) }}" method="get">
              <label for="size_{{ p.id }}">Size:</label>
              <select name="size" id="size_{{ p.id }}" required>
                {% for s in p.sizes %}
                  <option value="{{ s }}">{{ s }}</option>
                {% endfor %}
              </select>
              <button type="submit">Add to Cart</button>
            </form>
          {% else %}
            <span style="color:red;">Out of stock</span>
          {% endif %}
        {% else %}
          <a class="button" href="{{ url_for('auth.login') }}">Login to Buy</a>
      {% endif %}
    </div>
  {% else %}
    <p>No products found.</p>
  {% endfor %}
</div>
{% endblock %}